# 🚀 Modeunsa 자동 배포 가이드

Modeunsa 프로젝트는 Github Actions와 K3s(Kubernetes)를 활용하여 **모듈별 독립 자동 배포**를 수행합니다. 특정 모듈의 코드를 수정한 뒤 전체 서버를 내릴 필요 없이, 수정한 모듈만 쏙 골라서 안전하게 무중단 배포할 수 있습니다.

## 📌 배포 기본 원칙
1. **운영 배포는 오직 `main` 브랜치에서만 가능합니다.** 다른 브랜치(예: `develop`)에서 배포를 시도하면 파이프라인이 자동으로 차단합니다.
2. 코드를 병합(Merge)한다고 해서 바로 배포되지 않습니다. 개발자가 **명시적으로 릴리즈 태그(Tag)를 생성하여 푸시할 때만** 배포가 시작됩니다.

---

## 🏷️ 태그 네이밍 규칙
배포를 트리거하는 태그는 반드시 다음 형식을 지켜야 합니다.

* **형식:** `[모듈명]-v[버전]`
* **사용 가능한 모듈명 목록**:
  * **프론트엔드:** `web-client`
  * **백엔드:** `api-gateway`, `settlement`, `member`, `payment`, `order`, `product`, `file`, `inventory`

*(예시: 멤버 모듈 1.0.2 버전 배포 시 -> `member-v1.0.2`)*

---

## 🛠️ 실전 배포 3단계 (How to Deploy)

새로운 기능을 개발하고 운영 서버에 반영하고 싶다면 아래 순서를 따라주세요.

### Step 1. 코드를 main 브랜치로 병합
모든 개발과 테스트(PR 리뷰 등)를 마치고 코드를 `main` 브랜치에 Merge 합니다.

### Step 2. 로컬에서 최신 main 브랜치 태그 생성
로컬 환경의 터미널에서 `main` 브랜치를 최신 상태로 당겨온(pull) 뒤, 배포할 모듈의 태그를 생성합니다.

```bash
# 예시 1) 프론트엔드 배포
git tag web-client-v1.1.0

# 예시 2) 백엔드 결제(payment) 모듈 배포
git tag payment-v2.0.1

```

### Step 3. 깃허브로 태그 푸시 (배포 시작!)

생성한 태그를 깃허브 서버로 푸시합니다.

```bash
# 예시) 결제 모듈 태그 푸시
git push origin payment-v2.0.1

```

🎉 **끝입니다!** 이제 Github의 `Actions` 탭에 들어가 보시면, 파이프라인이 지정된 모듈만 도커 이미지로 빌드하고 EC2 서버에 안전하게 롤링 업데이트하는 과정을 확인하실 수 있습니다.

---

## ⚙️ `deploy.yml` 파이프라인 작동 원리 (내부 구조)

Github Actions에 등록된 `deploy.yml`은 태그 푸시를 감지하면 다음과 같은 6단계의 자동화 프로세스를 거칩니다.

### 1. 배포 안전장치 검증 (`Verify Tag is on main branch`)

* 푸시된 태그가 `main` 브랜치의 커밋 히스토리에 포함되어 있는지 `git` 명령어로 검사합니다.
* 만약 테스트가 덜 끝난 `develop` 브랜치에서 태그가 푸시되었다면, 운영 서버 보호를 위해 파이프라인을 즉시 강제 종료(Fail)합니다.

### 2. 태그 분석 및 대상 모듈 지정 (`Parse Tag and Determine Module`)

* `payment-v2.0.1` 이라는 태그를 분석하여, 대상 모듈(`payment`)과 새 버전(`2.0.1`)을 추출합니다.
* 해당 모듈이 백엔드(Spring Boot)인지 프론트엔드(Next.js)인지 판별하여 다음 빌드 단계를 결정합니다.

### 3. 스마트 빌드 및 도커 푸시 (`Build and push image`)

* **백엔드인 경우:** 대상 모듈 하나만 `bootBuildImage` 기능을 사용하여 도커 이미지로 빌드하고 Docker Hub에 Push 합니다.
* **프론트엔드인 경우:** `web-client` 폴더의 Dockerfile을 사용하여 이미지를 빌드하고 Docker Hub에 Push 합니다.

### 4. K8s 매니페스트 파일 전송 (`Copy k8s directory to EC2`)

* 최신 인프라 설정이 담긴 레포지토리의 `k8s/` 폴더를 EC2 서버(`/home/ec2-user/app`)로 안전하게 덮어쓰기 복사합니다.

### 5. 무중단 환경 변수 업데이트 (`Update .env.k3s-prod`, `Create DB`)

* EC2에 접속한 뒤, 서버에 존재하는 `.env.k3s-prod` 파일을 직접 수정합니다.
* 전체 파일을 덮어쓰지 않고 `sed` 명령어를 활용해 **이번에 빌드된 모듈의 이미지 변수(`PAYMENT_IMAGE` 등) 한 줄만 최신 버전으로 안전하게 교체**합니다.
* 이를 통해 `JWT_SECRET` 등 중요한 보안 키들이 깃허브 노출 없이 안전하게 유지됩니다.
* [백엔드 배포 시] 파이프라인이 클러스터 내의 MySQL에 접속하여 modeunsa_[모듈명] 형태의 데이터베이스가 있는지 확인하고, 존재하지 않는다면 자동으로 생성합니다.

### 6. k3s (Kubernetes) 롤링 업데이트 배포 (`Deploy on EC2`)

* 마지막으로 `sudo ./k8s/app.sh up prod` 명령어를 실행합니다.
* k3s가 갱신된 환경변수를 읽고, 변경된 모듈의 파드(Pod)만 새 도커 이미지로 교체하며 무중단 배포를 완료합니다.

---

## 🚨 주의사항 

### Common 모듈 수정 시

- 백엔드의 `common` 모듈 내용이나 루트 프로젝트의 `build.gradle` 등을 수정한 경우, 해당 변경 사항의 영향을 받는 **모든 백엔드 모듈의 버전을 각각 올려주어야 합니다.**
파이프라인은 태그에 적힌 단 하나의 모듈만 배포하므로, 영향받는 모듈별로 태그를 각각 생성하여 푸시해 주세요.

### 안전한 순차 배포 (Queue 시스템 적용)

- 여러 개의 모듈 태그를 동시에 푸시하더라도 배포가 꼬일 걱정은 하지 않으셔도 됩니다. 파이프라인에 자체 대기열이 설정되어 있어, 기존 배포가 취소되지 않고 순차적으로 하나씩 안전하게 배포됩니다.

### 백엔드 빌드 환경
- 백엔드 모듈의 컨테이너 빌드는 JDK 21 환경을 기준으로 수행됩니다.

---

> 참고: `content-service` 모듈은 현재 K8s 배포 인프라 및 자동 배포 파이프라인(Helm 차트, `k8s/app.sh` 등)에 포함되어 있지 않아, 위 태그 기반 자동 배포 대상에 포함되지 않습니다.

---

## 🚀 멀티 모듈 자동 배포 스크립트 (`deploy-multi.sh`) 사용 가이드

`common` 모듈 등을 수정하여 여러 개의 백엔드 모듈을 동시에 배포해야 할 때, 일일이 태그를 생성하고 푸시하는 번거로움을 줄여주는 자동화 스크립트입니다.

### ⚠️ 중요: `member` 모듈 배포 순서
모듈 간의 의존성 및 배포 안전성을 위해, **여러 모듈을 배포할 때 `member` 모듈이 포함되어 있다면 반드시 가장 마지막 순서로 입력해 주세요.**

### ✨ 사용 방법

**1. 스크립트 실행**
로컬 터미널(Git Bash, Mac Terminal 등)에서 프로젝트 루트 경로에 있는 스크립트를 실행합니다. 
```bash
./deploy-multi.sh
```

*(참고: 최초 실행 시 권한 에러가 발생한다면 `chmod +x deploy-multi.sh` 명령어로 실행 권한을 먼저 부여해 주세요.)*

**2. 대상 모듈 입력**
프롬프트의 안내에 따라 배포할 대상 모듈의 이름들을 **띄어쓰기로 구분**하여 순서대로 입력합니다.

```text
배포할 모듈 이름들을 순서대로 입력하세요: order payment member
```

**3. 개별 버전 입력**
스크립트가 입력한 모듈들을 순회하며 각각의 새로운 버전을 물어봅니다. 모듈별로 알맞은 버전을 입력해 주세요. (앞에 `-v`는 빼고 숫자만 입력합니다.)

```text
[order] 모듈의 새로운 버전을 입력하세요 (예: 1.0.3): 1.1.0
[order] 태그 생성 및 푸시 중: order-v1.1.0
[order] 성공적으로 푸시되었습니다!
-------------------------------------------------
[payment] 모듈의 새로운 버전을 입력하세요 (예: 1.0.3): 2.0.1
...
```

**4. 배포 확인**
스크립트가 입력받은 순서대로 태그를 생성하고 원격 저장소에 푸시합니다. 모든 푸시가 완료되면 Github의 `Actions` 탭으로 이동하여 지정된 모듈들이 대기열에 맞춰 순차적으로 무중단 배포되는 과정을 확인합니다.