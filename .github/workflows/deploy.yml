name: CD Pipeline

on:
  push:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      common: ${{ steps.filter.outputs.common }}
      api_gateway: ${{ steps.filter.outputs.api_gateway }}
      settlement: ${{ steps.filter.outputs.settlement }}
      member: ${{ steps.filter.outputs.member }}
      payment: ${{ steps.filter.outputs.payment }}
      order: ${{ steps.filter.outputs.order }}
      product: ${{ steps.filter.outputs.product }}
      file: ${{ steps.filter.outputs.file }}
      inventory: ${{ steps.filter.outputs.inventory }}
      web_client: ${{ steps.filter.outputs.web_client }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            common:
              - 'common/**'
              - 'build.gradle'
              - 'settings.gradle'
              - 'gradle/**'
            api_gateway:
              - 'api-gateway-service/**'
            settlement:
              - 'settlement-service/**'
            member:
              - 'member-service/**'
            payment:
              - 'payment-service/**'
            order:
              - 'order-service/**'
            product:
              - 'product-service/**'
            file:
              - 'file-service/**'
            inventory:
              - 'inventory-service/**'
            web_client:
              - 'web-client/**'

  deploy:
    name: Build & Deploy
    needs: changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set Version
        run: |
          VERSION=$(date +'%Y%m%d')-${{ github.run_number }}
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Determine changed modules
        id: set-modules
        run: |
          MODULES_TO_BUILD=()
          
          if [[ "${{ needs.changes.outputs.common }}" == 'true' ]]; then
            echo "Common module changed. Building ALL backend modules."
            MODULES_TO_BUILD=("api-gateway-service" "settlement-service" "member-service" "payment-service" "order-service" "product-service" "file-service" "inventory-service")
          else
            [[ "${{ needs.changes.outputs.api_gateway }}" == 'true' ]] && MODULES_TO_BUILD+=("api-gateway-service")
            [[ "${{ needs.changes.outputs.settlement }}" == 'true' ]] && MODULES_TO_BUILD+=("settlement-service")
            [[ "${{ needs.changes.outputs.member }}" == 'true' ]] && MODULES_TO_BUILD+=("member-service")
            [[ "${{ needs.changes.outputs.payment }}" == 'true' ]] && MODULES_TO_BUILD+=("payment-service")
            [[ "${{ needs.changes.outputs.order }}" == 'true' ]] && MODULES_TO_BUILD+=("order-service")
            [[ "${{ needs.changes.outputs.product }}" == 'true' ]] && MODULES_TO_BUILD+=("product-service")
            [[ "${{ needs.changes.outputs.file }}" == 'true' ]] && MODULES_TO_BUILD+=("file-service")
            [[ "${{ needs.changes.outputs.inventory }}" == 'true' ]] && MODULES_TO_BUILD+=("inventory-service")
          fi
          
          BUILT_MODULES="${MODULES_TO_BUILD[*]}"
          echo "BUILT_MODULES=$BUILT_MODULES" >> $GITHUB_ENV
          
          if [[ "${{ needs.changes.outputs.web_client }}" == 'true' ]]; then
            echo "BUILD_FRONTEND=true" >> $GITHUB_ENV
          fi
          
          if [ -z "$BUILT_MODULES" ] && [ "${{ needs.changes.outputs.web_client }}" != 'true' ]; then
            echo "No modules changed. Skipping build and deploy."
            echo "SKIP_DEPLOY=true" >> $GITHUB_ENV
          fi

      - name: Build and push backend images
        if: env.SKIP_DEPLOY != 'true' && env.BUILT_MODULES != ''
        run: |
          chmod +x gradlew
          for MODULE in $BUILT_MODULES; do
            echo "====================================="
            echo "Building Backend: $MODULE"
            echo "====================================="
          
            MODULE_SHORT=${MODULE%-service}
            IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/modeunsa-$MODULE_SHORT"
          
            ./gradlew :$MODULE:bootBuildImage --imageName=$IMAGE_NAME:${{ env.VERSION }}
            docker push $IMAGE_NAME:${{ env.VERSION }}
          done

      - name: Build and push frontend image
        if: env.SKIP_DEPLOY != 'true' && env.BUILD_FRONTEND == 'true'
        run: |
          echo "====================================="
          echo "Building Frontend (web-client)"
          echo "====================================="
          IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/modeunsa-web-client"
          
          # 수정됨: web-client 폴더를 참조하여 도커 빌드
          docker build -t $IMAGE_NAME:${{ env.VERSION }} ./web-client
          docker push $IMAGE_NAME:${{ env.VERSION }}

      - name: Copy k8s directory to EC2
        if: env.SKIP_DEPLOY != 'true'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_KEY }}
          source: "k8s/"
          target: "/home/ec2-user/app"

      - name: Update .env.k3s-prod and Deploy on EC2
        if: env.SKIP_DEPLOY != 'true'
        uses: appleboy/ssh-action@v1.0.3
        env:
          VERSION: ${{ env.VERSION }}
          BUILT_MODULES: ${{ env.BUILT_MODULES }}
          BUILD_FRONTEND: ${{ env.BUILD_FRONTEND }}
          DOCKER_USER: ${{ secrets.DOCKER_USERNAME }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_KEY }}
          envs: VERSION,BUILT_MODULES,BUILD_FRONTEND,DOCKER_USER
          script: |
            set -e
            cd /home/ec2-user/app
            
            # 1. 백엔드 환경변수 업데이트
            if [ -n "$BUILT_MODULES" ]; then
              for MODULE in $BUILT_MODULES; do
                MODULE_SHORT=${MODULE%-service}
                ENV_KEY=$(echo "$MODULE_SHORT" | tr 'a-z-' 'A-Z_')_IMAGE
            
                NEW_IMAGE="${DOCKER_USER}/modeunsa-${MODULE_SHORT}:${VERSION}"
            
                if grep -q "^${ENV_KEY}=" .env.k3s-prod; then
                  sed -i "s|^${ENV_KEY}=.*|${ENV_KEY}=${NEW_IMAGE}|" .env.k3s-prod
                else
                  echo "${ENV_KEY}=${NEW_IMAGE}" >> .env.k3s-prod
                fi
                echo "Updated $ENV_KEY"
              done
            fi
            
            # 2. 프론트엔드 환경변수 업데이트
            if [ "$BUILD_FRONTEND" == "true" ]; then
              NEW_FRONTEND_IMAGE="${DOCKER_USER}/modeunsa-web-client:${VERSION}"
              if grep -q "^FRONTEND_IMAGE=" .env.k3s-prod; then
                sed -i "s|^FRONTEND_IMAGE=.*|FRONTEND_IMAGE=${NEW_FRONTEND_IMAGE}|" .env.k3s-prod
              else
                echo "FRONTEND_IMAGE=${NEW_FRONTEND_IMAGE}" >> .env.k3s-prod
              fi
              echo "Updated FRONTEND_IMAGE"
            fi
            
            # 3. k3s 배포 스크립트 실행
            chmod +x ./k8s/*.sh
            sudo ./k8s/app.sh up prod